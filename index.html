<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>안전한 등굣길 지도</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --bg: #f5f6f7;
      --panel: rgba(255,255,255,0.85);
      --border: rgba(0,0,0,0.08);
      --text: #0b0c0e;
      --muted: #6b7280;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    .app{display:grid;grid-template-columns:320px 1fr;height:100%}
    #map{width:100%;height:100%}

    /* Desktop sidebar */
    aside{display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--panel);backdrop-filter:blur(16px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .title{font-weight:700;font-size:16px;letter-spacing:.2px}
    .btn{border:none;background:#111;color:#fff;font-size:13px;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#f3f4f6;color:#111}
    .list{flex:1;overflow-y:auto;padding:12px 16px;display:grid;gap:8px}
    .poi{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
    .poi-name{font-size:14px;font-weight:600}
    .poi-meta{font-size:12px;color:var(--muted)}
    .hint{font-size:11px;color:var(--muted);padding:8px 16px;border-top:1px dashed var(--border)}

    /* Mobile: hide sidebar, show map-topbar overlay */
    .map-topbar{display:none;} /* default hidden on desktop */
    @media(max-width: 900px){
      .app{grid-template-columns:1fr}
      aside{display:none}
      .map-topbar{
        display:flex; gap:8px; align-items:center;
        position:fixed; top:0; left:0; right:0; z-index:1000;
        padding:10px 12px;
        background:rgba(255,255,255,0.9);
        backdrop-filter: blur(14px);
        border-bottom:1px solid var(--border);
      }
      .map-topbar .title{font-size:15px; font-weight:700}
      .map-topbar .btn{padding:8px 10px; border-radius:10px; font-size:13px}
      .map-topbar select{
        height:34px; border-radius:10px; border:1px solid var(--border);
        padding:0 10px; background:#fff; font-size:13px; flex:1;
      }
      #map{margin-top:58px} /* leave room for the fixed topbar */
    }

    /* Dark Mode */
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0c0e; --panel:rgba(20,20,22,.7); --text:#e5e7eb; --border:rgba(255,255,255,.08); }
      .poi{background:#191a1c;border-color:var(--border)}
      .btn.secondary{background:#1f2937;color:#e5e7eb}
      .map-topbar{background:rgba(20,20,22,.86)}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Desktop Sidebar -->
  <aside id="sidebar">
    <div class="topbar">
      <span class="title">안전한 등굣길</span>
      <div>
        <button class="btn secondary" id="fitBtn" title="모든 원 보기">전체</button>
        <button class="btn" id="locBtn" title="내 위치 보기">내 위치</button>
      </div>
    </div>
    <div class="list" id="poiList"></div>
    <div class="hint">목록을 탭하면 해당 지점으로 확대됩니다. (모바일은 상단 바에서 조작)</div>
  </aside>

  <!-- Map -->
  <main id="map"></main>

  <!-- Mobile Top Bar (항상 CSS로 제어; JS 불필요) -->
  <div class="map-topbar" id="mapTopbar" aria-label="모바일 상단 조작 바">
    <span class="title">등굣길</span>
    <select id="poiSelect" aria-label="지점 선택">
      <option value="">지점 선택…</option>
    </select>
    <button class="btn secondary" id="mFitBtn">전체</button>
    <button class="btn" id="mLocBtn">내 위치</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== 데이터 (예시) =====
const POINTS = [
  {name:"학교 앞",count:10},
  {name:"여의나루역",count:7},
  {name:"여의도 시범아파트",count:3},
  {name:"여의도중학교",count:3}
];

// ===== 지도: CARTO light_all (원래대로) =====
const map = L.map('map').setView([37.5239,126.9270],14);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:20
}).addTo(map);

const bounds = L.latLngBounds();
const circles = [];
const minCount = Math.min(...POINTS.map(p=>p.count));
const maxCount = Math.max(...POINTS.map(p=>p.count));
function scale(val,inMin,inMax,outMin,outMax){
  if (inMax === inMin) return (outMin+outMax)/2;
  return outMin + (val-inMin)*(outMax-outMin)/(inMax-inMin);
}

// Focus Mode
function focusOnly(name){
  circles.forEach(c=>{
    const on = (c.options._name === name);
    c.setStyle({ fillOpacity: on ? 0.85 : 0.15, opacity: on ? 1 : 0.2 });
  });
}

// 원 생성
function addCircle(lat,lng,name,count){
  const radius = scale(count,minCount,maxCount,70,220);
  const circle = L.circle([lat,lng],{
    radius,
    color:"#7f1d1d",
    weight:1.2,
    fillColor:"#ef4444",
    fillOpacity:0.68,
    _name:name
  }).addTo(map);
  circle.bindPopup(`<b>${name}</b><br>언급수: ${count}`);
  circle.on('click', ()=>{ focusOnly(name); });
  circles.push(circle);
  bounds.extend([lat,lng]);
}

// 좌표(샘플)
const coords = {
  "학교 앞":[37.5241,126.9345],
  "여의나루역":[37.5271,126.9327],
  "여의도 시범아파트":[37.5230,126.9350],
  "여의도중학교":[37.5200,126.9330]
};
for(const p of POINTS){
  const [lat,lng]=coords[p.name];
  addCircle(lat,lng,p.name,p.count);
}
if (bounds.isValid()) map.fitBounds(bounds);

// Desktop 사이드바 목록
function renderList(){
  const host=document.getElementById("poiList"); if(!host) return;
  host.innerHTML="";
  for(const p of POINTS){
    const el=document.createElement("div");
    el.className="poi";
    el.innerHTML=`<div><div class="poi-name">${p.name}</div><div class="poi-meta">${p.count}건</div></div><button class="btn secondary" data-name="${p.name}">보기</button>`;
    host.appendChild(el);
  }
  host.querySelectorAll("button[data-name]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const name=btn.dataset.name;
      const [lat,lng]=coords[name];
      map.setView([lat,lng],17,{animate:true});
      focusOnly(name);
    });
  });
}
renderList();

// Mobile 상단 바 셀렉트 (항상 존재, CSS가 표시 제어)
(function setupMobileTopbar(){
  const sel = document.getElementById("poiSelect");
  sel.innerHTML = '<option value="">지점 선택…</option>';
  for(const p of POINTS){ 
    const opt = document.createElement('option'); 
    opt.value = p.name; opt.textContent = `${p.name} · ${p.count}`; 
    sel.appendChild(opt);
  }
  sel.onchange = ()=>{
    const name = sel.value;
    if(!name) return;
    const [lat,lng] = coords[name];
    map.setView([lat,lng], 17, {animate:true});
    focusOnly(name);
  };
})();

// 위치 기능 (공용 버튼)
let myMarker,myCircle;
function locate(){
  if(!navigator.geolocation){alert("이 브라우저는 위치 기능을 지원하지 않습니다.");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude:lat,longitude:lng,accuracy} = pos.coords;
    if(myMarker){map.removeLayer(myMarker);} if(myCircle){map.removeLayer(myCircle);}
    myMarker=L.circleMarker([lat,lng],{radius:6,color:"#111",weight:2,fillColor:"#3b82f6",fillOpacity:0.9}).addTo(map).bindPopup("내 위치");
    myCircle=L.circle([lat,lng],{radius:accuracy||50,color:"#2563eb",weight:1,fillColor:"#60a5fa",fillOpacity:0.2}).addTo(map);
    map.flyTo([lat,lng],17);
  },()=>alert("위치 권한을 허용해주세요."),{enableHighAccuracy:true,timeout:8000,maximumAge:0});
}
document.getElementById("locBtn").addEventListener("click", locate);
document.getElementById("mLocBtn").addEventListener("click", locate);

// 전체 보기 (포커스 해제)
function fitAll(){
  circles.forEach(c=> c.setStyle({ fillOpacity:0.68, opacity:1 }));
  if (bounds.isValid()) map.fitBounds(bounds);
}
document.getElementById("fitBtn").addEventListener("click", fitAll);
document.getElementById("mFitBtn").addEventListener("click", fitAll);
</script>
</body>
</html>
