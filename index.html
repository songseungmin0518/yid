<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>빛나눔 프로젝트</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;}
  #title{
    position:fixed;top:14px;left:50%;transform:translateX(-50%);
    background:rgba(255,255,255,.85);backdrop-filter:blur(6px);
    padding:6px 14px;border-radius:12px;
    font-weight:600;font-size:15px;z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
  }
  .speed-pill{
    position:fixed;right:14px;top:14px;z-index:1000;
    background:rgba(17,17,17,.85);color:#fff;border-radius:999px;
    padding:8px 14px;font-size:13px;box-shadow:0 4px 14px rgba(0,0,0,.15)
  }
  .legend{
    position:fixed;right:14px;bottom:70px;z-index:1000;
    background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.1);
    border-radius:10px;padding:10px 12px;font-size:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
  }
  .row{display:flex;align-items:center;gap:6px;margin-top:4px}
  .chip{width:20px;height:8px;border-radius:4px}
  .dev-badge{
    position:fixed;left:14px;bottom:14px;z-index:1000;
    background:rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.1);
    border-radius:999px;padding:6px 10px;font-size:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.08)
  }

  /* === 따라가기 버튼 (흰색 + 진한 텍스트) === */
  .follow-btn{
    position:fixed;
    right:14px;bottom:14px;z-index:1001;
    background:#ffffff;
    color:#111;
    border:1px solid rgba(0,0,0,.25);
    border-radius:8px;
    padding:8px 14px;
    font-size:12px;
    font-weight:700;
    box-shadow:0 2px 8px rgba(0,0,0,.2);
    cursor:pointer;
    transition:all .25s;
  }
  .follow-btn:hover{ background:#f1f1f1; }
  .follow-btn.off{
    background:#ffffff;color:#888;border-color:rgba(0,0,0,.15);
    box-shadow:0 1px 5px rgba(0,0,0,.1);
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="title">빛나눔 프로젝트</div>
<div class="speed-pill"><span id="spd">-.-</span> km/h</div>
<div class="legend">
  <b>위험 구간</b>
  <div class="row"><span class="chip" style="background:#e53935"></span>높음(빨강)</div>
  <div class="row"><span class="chip" style="background:#ff7a00"></span>주의(주황)</div>
  <div class="row"><span class="chip" style="background:#00c853"></span>낮음(초록)</div>
</div>
<div class="dev-badge">Developer : <span id="dev-name"></span></div>

<!-- 따라가기 버튼 -->
<button id="followBtn" class="follow-btn">내 위치</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DEV_NAME = "송승민 (10710)";
document.getElementById('dev-name').textContent = DEV_NAME;

/* ===== 지도 설정 ===== */
const map = L.map('map', { zoomControl:false }).setView([37.5249,126.9335], 16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  subdomains:'abcd',maxZoom:20,attribution:'© OpenStreetMap & CARTO'
}).addTo(map);

/* ==================================================================== */

/* ===== 위험 구간 표시 ===== */
function drawLine(coords,color){L.polyline(coords,{color,weight:6,opacity:.95}).addTo(map);}

/* ===== 장미 - 정문 ===== */
const red1=[[37.523572,126.933236],[37.524846,126.935203]];

/* ===== 장미 - 화랑 ===== */
const red2=[[37.523572,126.933236],[37.521413,126.935403]];

/* ===== 공작상가 - 여의나루 ===== */
const red3=[[37.525388,126.930203],[37.526851,126.932534]];

/* ==================================================================== */

/* ===== 수정앞 - 장미 ===== */
const orange1=[[37.522027,126.930762],[37.523572,126.933236]];

/* ===== 여초 - 여의나루 ===== */
const orange2=[[37.522933,126.937712],[37.526851,126.932534]];

/* ===== 파바 - 여초 ===== */
const orange3=[[37.520660,126.934149],[37.522933,126.937712]];

/* ===== 브라이튼 - 공작상가 ===== */
const orange4=[[37.524341,126.928403],[37.525388,126.930203]];

/* ===== 공작상가 - 공작아파트 ===== */
const orange5=[[37.525388,126.930203],[37.526411,126.929161]];

/* ===== 서울아파트 - 여의나루 ===== */
const orange6=[[37.527444,126.931781],[37.526851,126.932534]];

/* ==================================================================== */

/* ===== 브라이튼 - 한양상가 ===== */
const green1=[[37.524341,126.928403],[37.519886,126.932920]];

/* ===== 한양상가 - 파바 ===== */
const green2=[[37.519886,126.932920],[37.520660,126.934149]];

/* ===== 파바 - 브라이튼과 페어몬트 사이===== */
const green3=[[37.520660,126.934149],[37.525093,126.929737]];

/* ==================================================================== */

[red1,red2,red3].forEach(l=>drawLine(l,"#e53935"));
[orange1,orange2,orange3,orange4,orange5,orange6].forEach(l=>drawLine(l,"#ff7a00"));
[green1,green2,green3].forEach(l=>drawLine(l,"#00c853"));

/* ===== 실시간 위치 추적 ===== */
let marker=null, circle=null, watchId=null, lastFix=null, speedEMA=null;
const spdEl=document.getElementById('spd');
let followUser = true;     // 초기 자동 따라가기 ON
let hadFirstFix = false;
const followBtn = document.getElementById('followBtn');

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function updateSpeed(kmh){
  const a=0.3;
  speedEMA=(speedEMA==null)?kmh:a*kmh+(1-a)*speedEMA;
  spdEl.textContent=(speedEMA??kmh).toFixed(1);
}
function showLocation(lat,lng,acc,ts,spd){
  const latlng=[lat,lng];
  if(!marker){marker=L.marker(latlng,{title:"내 위치"}).addTo(map);}else marker.setLatLng(latlng);
  if(!circle){circle=L.circle(latlng,{radius:acc||30,color:"#1976d2",weight:2,opacity:.9,fillColor:"#42a5f5",fillOpacity:.2}).addTo(map);}
  else{circle.setLatLng(latlng);if(acc)circle.setRadius(acc);}

  let mps=(typeof spd==='number'&&isFinite(spd))?spd:NaN;
  if(!isFinite(mps)&&lastFix){
    const dt=(ts-lastFix.time)/1000;
    if(dt>0.5&&dt<20){
      const dist=haversine(lastFix.lat,lastFix.lng,lat,lng);
      mps=(dist<Math.max(acc||10,10))?0:dist/dt;
    }
  }
  const kmh=isFinite(mps)?mps*3.6:NaN;
  if(isFinite(kmh))updateSpeed(kmh);

  // 따라가기 ON일 때만 지도 이동
  if(!hadFirstFix || followUser){
    map.setView(latlng, map.getZoom(), {animate:true});
  }
  hadFirstFix = true;
  lastFix={lat,lng,time:ts};
}

/* ===== 위치 트래킹 시작 ===== */
function startTracking(){
  if(!('geolocation' in navigator))return;
  if(watchId!=null)return;
  watchId=navigator.geolocation.watchPosition(
    pos=>{
      const {latitude,longitude,accuracy,speed}=pos.coords;
      const ts=pos.timestamp||Date.now();
      showLocation(latitude,longitude,accuracy,ts,speed);
      localStorage.setItem('geoConsent','granted');
    },
    err=>console.warn(err.message),
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

/* ===== 지도 조작 시 따라가기 OFF ===== */
['dragstart','zoomstart','movestart'].forEach(ev=>{
  map.on(ev, ()=>{
    if(followUser){
      followUser=false;
      followBtn.classList.add('off');   // 시각적으로 OFF 상태
      // 버튼 텍스트는 항상 "내 위치" 유지(요청 사항대로)
    }
  });
});

/* ===== 버튼 클릭: 항상 따라가기 ON + 즉시 리센터 ===== */
followBtn.addEventListener('click', ()=>{
  followUser = true;                   // 토글이 아니라 무조건 ON
  followBtn.classList.remove('off');   // 시각적으로 ON 상태
  if(marker){
    const ll = marker.getLatLng();
    map.setView(ll, map.getZoom(), {animate:true});
  }
});

/* ===== 자동 시작 ===== */
async function initGeo(){
  const saved=localStorage.getItem('geoConsent');
  if(saved==='granted'){startTracking();return;}
  try{
    if(navigator.permissions&&navigator.permissions.query){
      const st=await navigator.permissions.query({name:'geolocation'});
      if(st.state==='granted'){localStorage.setItem('geoConsent','granted');startTracking();return;}
    }
  }catch(e){}
  startTracking(); 
}
window.addEventListener('DOMContentLoaded',initGeo);
</script>
</body>
</html>
